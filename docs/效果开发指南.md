# 效果开发指南（面向 Kotlin 新手）

讲清楚效果（buff/debuff）是怎么写的、为什么这样做，以及如何新建一个效果。

## 效果类长什么样
- 基类：`Effect`（抽象类）
  - 关键字段：`code`（唯一）、`name`、`type`（BUFF/DEBUFF/ONLY_*）、`trigger`（触发时机）、`duration`、`priority`、`onNumericImpact`
  - 重要属性：`value`（强度，需在子类里定义），`source`（默认副本环境，可覆盖）
  - 可覆写方法：
    - `onApply` / `onRemove`：加上/移除时的处理
    - `onTurn`：在触发时机被调用（如伤害计算前）
    - `applyImpact`：直接造成伤害/治疗
    - `merge`：处理唯一效果的叠加策略
- 作用：把持续或一次性效果的逻辑封装起来，并由触发器控制调用时机。

## 现有示例
- `DodgeEffect`：`Trigger.ON_DAMAGE_CALCULATE`，按概率把伤害改为 0（非真实伤害时）。
- `PoisonEffect`：`Trigger.ON_TURN_SETTLE`，按攻击力×系数对目标追加伤害。
- Registrar：`DodgeEffectRegistrar` / `PoisonEffectRegistrar` 在 `init` 中 `EffectFactory.register(...)`。

## 为什么用触发器
- 战斗流程会在特定节点筛选效果：副本开始、回合开始、技能释放、伤害计算、回合结算、副本结束。
- 把“何时生效”抽象成枚举，新增效果时只需选对时机并实现对应方法。

## 我想写一个新效果，步骤
1) 新建类继承 `Effect`，设置唯一 `code`、`name`、`type`、`trigger`、`duration`（-1 表示永久）、`priority`。
2) 定义 `override var value: Float`（或需要的参数），可在构造函数传入。
3) 按需覆写：
   - `onApply`：效果添加时的初始化（如加护盾值）。
   - `onTurn`：在触发时机内修改伤害/属性（如减伤、易伤）。
   - `applyImpact`：直接制造伤害/治疗（如中毒 DOT）。
   - `merge`：当同类效果再次添加时如何处理（覆盖/叠加/忽略）。
4) 在 Registrar `object XxxEffectRegistrar` 的 `init` 中 `EffectFactory.register(NewEffect(...))`。
5) 通过技能或装备调用：技能的 `getEffectCodes()` 返回该 code，或装备的 `generateEffects()` 返回实例。

## 规范建议
- code：`effect-<类型>-<来源>-<值>`，保持唯一；效果名与描述清晰说明“触发时机+作用”。
- 触发时机：选最接近的枚举；若需要即时改动伤害，放在 `ON_DAMAGE_CALCULATE`；若是回合末 DOT，用 `ON_TURN_SETTLE`。
- priority：数值越小优先级越高，可用于控制多效果的先后顺序。
- value 复用：`EffectFactory.take(code, value)` 可在 runtime 赋值，便于同一效果模板用不同强度。

## 常见问题
- “效果没触发”：检查触发器是否匹配当前流程节点；确保效果已注册且被正确添加到 `effects` 列表。
- “DOT 不结算”：确认是否在 `applyImpact`/`onTurn` 中写入 `damageTaken` 或直接修改属性。
- “唯一效果重复”：需要在 `merge` 中定义覆盖策略，或使用 `ONLY_*` 类型约束。

